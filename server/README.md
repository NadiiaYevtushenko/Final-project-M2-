# üõ°Ô∏è Express.js + Passport ‚Äî –°–µ—Ä–≤–µ—Ä–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è

–ü–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–∏–π —Å–µ—Ä–≤–µ—Ä –Ω–∞ Express.js —ñ–∑ SSR (Pug + EJS), –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—î—é —á–µ—Ä–µ–∑ Passport, —Å–µ—Å—ñ—è–º–∏, middleware, CORS, –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è–º —Ç–µ–º–∏ —Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∏–º–∏ –º–∞—Ä—à—Ä—É—Ç–∞–º–∏,–±–µ–∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö..
–î–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É –ø–∞–º'—è—Ç—ñ (–º–∞—Å–∏–≤), —Ç–æ–º—É –ø—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–µ—Ä–∞ –≤—Å—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è.

### üì¶ –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó

- Node.js + Express (5.x)
- Passport (–ª–æ–∫–∞–ª—å–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—è) (—Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ server.js)
- –°–µ—Å—ñ—ó —á–µ—Ä–µ–∑ express-session
- –®–∞–±–ª–æ–Ω—ñ–∑–∞—Ç–æ—Ä–∏: Pug (–∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è, –ø—Ä–æ—Ñ—ñ–ª—ñ) —Ç–∞ EJS (—Ç–æ–≤–∞—Ä–∏ ( –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ))
- CORS + cookie-parser
- JWT utility (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è API-–∑–∞–ø–∏—Ç—ñ–≤)
- Nodemailer (–≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—è)

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—î–∫—Ç—É

````
server/
‚îú‚îÄ‚îÄ public/
‚îÇ ‚îú‚îÄ‚îÄ images/
‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ picLogo.png
‚îÇ ‚îú‚îÄ‚îÄ scripts/
‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ theme.js
‚îÇ ‚îú‚îÄ‚îÄ favicon.ico
‚îÇ ‚îî‚îÄ‚îÄ style.css
‚îú‚îÄ‚îÄ src/
‚îÇ ‚îú‚îÄ‚îÄ config/
‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ jwtUtils.js
‚îÇ ‚îú‚îÄ‚îÄ controllers/
‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ views/
‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ ejs/
‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ partials/
‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ footer.ejs
‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ header.ejs
‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ products/
‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ index.ejs
‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ show.ejs
‚îÇ ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ pug/
‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ auth/
‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ login.pug
‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ protected.pug
‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ register.pug
‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ layouts/
‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ base.pug
‚îÇ ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ users/
‚îÇ ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ index.pug
‚îÇ ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ show.pug
‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ productController.js
‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ userController.js
‚îÇ ‚îú‚îÄ‚îÄ middleware/
‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ adminMiddleware.js
‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ authMiddleware.js
‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ errorHandlerMiddleware.js
‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ logRequestsMiddleware.js
‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ validationUserInput.js
‚îÇ ‚îú‚îÄ‚îÄ models/
‚îÇ ‚îî‚îÄ‚îÄ routes/
‚îÇ ‚îú‚îÄ‚îÄ productRoutes.js
‚îÇ ‚îú‚îÄ‚îÄ themeRoutes.js
‚îÇ ‚îî‚îÄ‚îÄ userRoutes.js
‚îú‚îÄ‚îÄ .env
‚îú‚îÄ‚îÄ package-lock.json
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ server.js
```


## üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ Passport (—Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ server.js)

- –õ–æ–∫–∞–ª—å–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—è (email + password)
- Passport session + express-session
- –°–µ—Å—ñ—ó –∑ cookie (httpOnly, secure)
- –°–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è/–¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è:

### –°–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è / –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è

Passport –∑–±–µ—Ä—ñ–≥–∞—î ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —É cookie –ø—Ä–∏ –≤—Ö–æ–¥—ñ (`serializeUser`), –∞ –ø–æ—Ç—ñ–º –≤—ñ–¥–Ω–æ–≤–ª—é—î –æ–±'—î–∫—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ –ø–∞–º‚Äô—è—Ç—ñ (`deserializeUser`):

```js
passport.serializeUser((user, done) => done(null, user.id));
passport.deserializeUser((id, done) => {
  const user = dummyUsers.find(u => u.id === Number(id));
  done(null, user || false);
});
```

---

## üß© –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å

### üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —Ç–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è

- SSR-—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è, –≤—Ö—ñ–¥, –∑–∞—Ö–∏—â–µ–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
- API-—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è, –≤—Ö—ñ–¥, –∑–∞—Ö–∏—â–µ–Ω—ñ –∑–∞–ø–∏—Ç–∏ —á–µ—Ä–µ–∑ JWT
- –°–µ—Å—ñ—ó —á–µ—Ä–µ–∑ cookie —Ç–∞ Passport
- Logout (–æ—á–∏—â–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤ –∞–±–æ —Å–µ—Å—ñ–π)

### üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ

- SSR: —Å–ø–∏—Å–æ–∫, –ø–µ—Ä–µ–≥–ª—è–¥, –∑–∞—Ö–∏—â–µ–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞
- API:
  - `GET /api/profile` ‚Äî –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é
  - `PUT /api/profile` ‚Äî –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (—ñ–º º—è, email, –ø–∞—Ä–æ–ª—å)
  - `POST /api/forgot-password` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è —Ç–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ email
- Middleware:
  - `protect` ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ —Å–µ—Å—ñ—é
  - `jwtProtect` ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ JWT —Ç–æ–∫–µ–Ω–∞ (–¥–ª—è API-–∑–∞–ø–∏—Ç—ñ–≤)

### üõí –¢–æ–≤–∞—Ä–∏

- SSR: `/products`, `/products/:id`
- API:
  - `GET /products/api`
  - `GET /products/api/:id`
  - `POST /products/api` (admin only)
  - `PUT /products/api/:id` (admin only)
  - `DELETE /products/api/:id` (admin only)

### üõ°Ô∏è –ê–¥–º—ñ–Ω –¥–æ—Å—Ç—É–ø

- Middleware `adminOnly` –æ–±–º–µ–∂—É—î CRUD –ø–æ —Ç–æ–≤–∞—Ä–∞—Ö
- –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–æ–∑–Ω–∞—á–∞—î—Ç—å—Å—è —è–∫ `isAdmin: true`

### üß™ –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—è

- `POST /api/forgot-password`
- –ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å –Ω–∞–¥—Å–∏–ª–∞—î—Ç—å—Å—è –Ω–∞ email
- –í—Å—è SMTP-–∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è ‚Äî —á–µ—Ä–µ–∑ `.env`

### üé® –¢–µ–º–∏

- –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–µ–º–∏ (light/dark) —É cookie
- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ SSR –∑ —Ç–µ–º–æ—é —á–µ—Ä–µ–∑ `res.locals.theme`

### üßæ Middleware

- `logRequestsMiddleware` ‚Äî –ª–æ–≥—É–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—ñ–≤
- `errorHandlerMiddleware` ‚Äî –≥–ª–æ–±–∞–ª—å–Ω–∏–π –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–º–∏–ª–æ–∫
- `validationUserInput.js` ‚Äî –±–∞–∑–æ–≤–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –≤–≤–µ–¥–µ–Ω–Ω—è

---

# üìß Email Configuration (Nodemailer)

–§—É–Ω–∫—Ü—ñ—è `/api/forgot-password` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î Nodemailer –¥–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ª–∏—Å—Ç—ñ–≤ —ñ–∑ –Ω–æ–≤–∏–º–∏ –ø–∞—Ä–æ–ª—è–º–∏. –î–ª—è —Ü—å–æ–≥–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∫–∞–∑–∞—Ç–∏ SMTP-–Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —É `.env`:

### üîê –ü—Ä–∏–∫–ª–∞–¥ server/.env

```
EMAIL_SERVICE=gmail
EMAIL_USER=your_email@gmail.com
EMAIL_PASS=your_app_password
NODE_ENV=development
```

### üìå –ü–æ—è—Å–Ω–µ–Ω–Ω—è –∑–º—ñ–Ω–Ω–∏—Ö

| –ó–º—ñ–Ω–Ω–∞          | –û–ø–∏—Å                                                              |
|------------------|-------------------------------------------------------------------|
| `EMAIL_SERVICE`  | –ü–æ—à—Ç–æ–≤–∞ —Å–ª—É–∂–±–∞ (`gmail`, `yahoo`, –∞–±–æ SMTP-—Ö–æ—Å—Ç)                 |
| `EMAIL_USER`     | Email, –∑ —è–∫–æ–≥–æ –±—É–¥—É—Ç—å –Ω–∞–¥—Å–∏–ª–∞—Ç–∏—Å—è –ª–∏—Å—Ç–∏                          |
| `EMAIL_PASS`     | App Password –∞–±–æ SMTP –ø–∞—Ä–æ–ª—å (–Ω–µ –∑–≤–∏—á–∞–π–Ω–∏–π –ø–∞—Ä–æ–ª—å!)              |
| `NODE_ENV`       | –ú–∞—î –±—É—Ç–∏ `production`, —â–æ–± –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ secure cookie              |

### ‚ö†Ô∏è Gmail users

1. –ê–∫—Ç–∏–≤—É–π—Ç–µ [2FA](https://myaccount.google.com/security).
2. –°—Ç–≤–æ—Ä—ñ—Ç—å [App Password](https://myaccount.google.com/apppasswords).
3. –í—Å—Ç–∞–≤—Ç–µ –≤ `.env` —É –≤–∏–≥–ª—è–¥—ñ `EMAIL_PASS=...`.

### üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

```http
POST /api/forgot-password
Content-Type: application/json

{
  "email": "user@example.com"
}
```

–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –æ—Ç—Ä–∏–º–∞—î –Ω–æ–≤–∏–π —Ç–∏–º—á–∞—Å–æ–≤–∏–π –ø–∞—Ä–æ–ª—å –Ω–∞ –ø–æ—à—Ç—É.



## ‚öôÔ∏è –ó–∞–ø—É—Å–∫

### –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ:

```bash
cd server
npm install
````

### –ó–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä:

```bash
npm start        # –∞–±–æ
npm run dev      # –∑ nodemon
```

## –í—ñ–¥–∫—Ä–∏–π—Ç–µ —É –±—Ä–∞—É–∑–µ—Ä—ñ:

http://localhost:5000/users/auth/register  
http://localhost:5000/users/auth/login
http://localhost:5000/users/auth/protected
